<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é€†å¤©æŒ‚æœºï¼šä¸€å‰‘é£å‡</title>

  <!-- éœé¹œæ–‡æ¥·å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+Screen&display=swap" rel="stylesheet">

  <style>
    @font-face {
      font-family: 'LXGW';
      src: url('https://cdn.jsdelivr.net/gh/lxgw/LxgwWenkaiWebFont@latest/fonts/LXGWWenKai-Regular.woff2') format('woff2');
      font-display: swap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'LXGW', 'LXGW WenKai Screen', 'Microsoft YaHei', sans-serif;
      background: url('https://cdn.jsdelivr.net/gh/mengzhuo/assets@main/xianxia-bg-final.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #e6e6e6;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .main-panel {
      flex: 3;
    }

    .sidebar {
      flex: 2;
      background: rgba(15, 25, 45, 0.7);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(100, 150, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      font-size: 2.4em;
      color: #d4af37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .stats {
      background: rgba(0, 0, 0, 0.4);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      line-height: 2;
      border-left: 5px solid #5ce6e6;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
    }

    .log {
      height: 280px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      padding: 14px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid rgba(100, 150, 255, 0.2);
    }

    .log div {
      margin-bottom: 6px;
      word-break: break-word;
    }

    button {
      background: #1e90ff;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 5px 2px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    button:hover {
      background: #3cb0ff;
      transform: scale(1.03);
    }

    button.red { background: #e94560; }
    button.green { background: #32cd32; }
    button.orange { background: #ff8c00; color: #000; }
    button.purple { background: #9932cc; }
    button.gray { background: #888; }

    button.btn-big {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
    }

    /* å“è´¨é¢œè‰² */
    .grade-0 { color: #aaa; }
    .grade-1 { color: white; }
    .grade-2 { color: #32cd32; }
    .grade-3 { color: #1e90ff; }
    .grade-4 { color: #9932cc; }
    .grade-5 { color: #ff8c00; }
    .grade-6 { color: #d4af37; font-weight: bold; }

    /* åˆ—è¡¨é¡¹ */
    .item-list {
      height: 120px;
      overflow-y: auto;
      margin-top: 10px;
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 6px;
      padding: 5px;
    }

    .item {
      padding: 8px;
      margin-top: 4px;
      background: rgba(30, 40, 80, 0.5);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .item:hover {
      background: rgba(60, 90, 160, 0.6);
      transform: translateX(5px);
    }

    /* å¼¹çª— */
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
    }

    .modal-content {
      background: rgba(20, 30, 60, 0.95);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      border: 1px solid #5ce6e6;
      color: white;
    }

    .modal-header {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #ff8c00;
    }

    .modal-body ul {
      list-style: none;
    }

    .modal-body li {
      margin: 8px 0;
      padding-left: 15px;
      position: relative;
    }

    .modal-body li:before {
      content: "âœ¦";
      position: absolute;
      left: 0;
      color: #5ce6e6;
    }

    .modal-footer {
      text-align: right;
      margin-top: 15px;
    }

    /* tab æ ‡ç­¾é¡µ */
    .tabs {
      display: flex;
      margin-bottom: 10px;
    }

    .tab {
      padding: 8px 16px;
      background: rgba(100, 100, 150, 0.3);
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: #1e90ff;
      color: white;
    }

    /* è¡€æ¡è“æ¡ */
    .bar {
      width: 100%;
      height: 10px;
      background: #333;
      border-radius: 5px;
      margin: 4px 0;
      overflow: hidden;
    }

    .hp-fill { background: #f44336; }
    .mp-fill { background: #2196f3; }
    .fill { height: 100%; transition: width 0.3s; }

    /* è£…å¤‡å¡ */
    .equip-card {
      padding: 10px;
      margin: 6px 0;
      background: rgba(30, 40, 80, 0.6);
      border-radius: 8px;
      font-size: 13px;
      border-left: 4px solid transparent;
    }

    .equip-card:hover {
      background: rgba(60, 90, 160, 0.6);
    }

    .skill-item {
      padding: 8px;
      margin: 4px 0;
      background: rgba(100, 50, 150, 0.4);
      border-radius: 6px;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- å¯åŠ¨å¼•å¯¼é¡µ -->
  <div class="guide-overlay" id="guideOverlay">
    <h2>ğŸŒŒ é€†å¤©æŒ‚æœºï¼šä¸€å‰‘é£å‡</h2>
    <p>ä½ æœ¬æ˜¯å‡¡äººï¼Œå´åœ¨å¤æ´ä¸­å¾—ä¸€æ®‹å·â€”â€”ã€Šæ··æ²Œåå¤©è¯€ã€‹ã€‚</p>
    <p>ä»æ­¤è¸ä¸Šé€†å¤©ä¿®è¡Œä¹‹è·¯ï¼Œæ–©å¦–é™¤é­”ï¼Œç‚¼å™¨ç‚¼ä¸¹ï¼Œç»ˆå°†æ‰“ç ´æ¡æ¢ï¼Œé£å‡æˆä»™ï¼</p>
    <p>é•‡å‹ä¸‡æ—ï¼Œå”¯æˆ‘ç‹¬å°Šï¼</p>
    <button class="btn btn-big orange" onclick="startGame()">âœ¨ ç‚¹æ­¤å¼€è„‰ï¼Œè¸å…¥ä¿®çœŸç•Œ</button>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainUI" style="display:none;">
    <h1>ã€Œé€†å¤©æŒ‚æœºã€ä¸€å‰‘é£å‡</h1>
    <div class="container">
      <div class="main-panel">
        <div class="stats" id="playerStats">åŠ è½½ä¸­...</div>
        <div class="log" id="combatLog"></div>
      </div>

      <div class="sidebar">
        <!-- Tab åˆ‡æ¢ -->
        <div class="tabs">
          <div class="tab active" data-tab="inventory">ğŸ’ èƒŒåŒ…</div>
          <div class="tab" data-tab="equips">âš”ï¸ è£…å¤‡</div>
          <div class="tab" data-tab="shop">ğŸ›’ å•†åº—</div>
          <div class="tab" data-tab="skills">ğŸ“š æŠ€èƒ½</div>
        </div>

        <!-- èƒŒåŒ… -->
        <div id="tab-inventory">
          <div>
            <label><input type="checkbox" id="autoPickup" checked> è‡ªåŠ¨æ‹¾å–</label>
            <select id="minGradeForPickup">
              <option value="0">ä¸å±è”½</option>
              <option value="1">æ™®é€šåŠä»¥ä¸Š</option>
              <option value="2">ç²¾è‰¯åŠä»¥ä¸Š</option>
              <option value="3">ç¨€æœ‰åŠä»¥ä¸Š</option>
              <option value="4">å²è¯—åŠä»¥ä¸Š</option>
              <option value="5">ç¥è¯åŠä»¥ä¸Š</option>
            </select>
          </div>
          <button onclick="discardAll()" class="red">ğŸ—‘ï¸ ä¸¢å¼ƒå…¨éƒ¨</button>
          <button onclick="sellAll()" class="green">ğŸ’° å‡ºå”®åƒåœ¾</button>
          <div class="item-list" id="inventoryList"></div>
        </div>

        <!-- è£…å¤‡æ  -->
        <div id="tab-equips" style="display:none;">
          <div id="equipslot"></div>
        </div>

        <!-- å•†åº— -->
        <div id="tab-shop" style="display:none;">
          <button onclick="refreshShop()" class="btn">ğŸ”„ åˆ·æ–°å•†åº—ï¼ˆå…è´¹ï¼‰</button>
          <div id="shopItems"></div>
        </div>

        <!-- æŠ€èƒ½ -->
        <div id="tab-skills" style="display:none;">
          <div id="skillList"></div>
        </div>

        <!-- å‰¯æœ¬é€‰æ‹© -->
        <h3>ğŸ¯ å½“å‰å‰¯æœ¬</h3>
        <select id="dungeonSelect"></select>
        <div id="dungeonInfo"></div>

        <!-- æŠ€èƒ½æŒ‰é’® -->
        <h3>ğŸŒ€ æŠ€èƒ½</h3>
        <button id="skillBtn" onclick="useSkill()" class="btn-big">ğŸ’¥ ä¸‡å‰‘å½’å®—ï¼ˆå†·å´ä¸­ï¼‰</button>

        <!-- æ¸¡åŠ«å° -->
        <h3>âš¡ æ¸¡åŠ«å°</h3>
        <div>å½“å‰è¿›åº¦ï¼š<span id="tribProgress">0</span>/100</div>
        <div class="bar"><div class="fill hp-fill" id="energyFill"></div></div>
        <button id="btnTrib" class="btn-big orange" style="display:none;" onclick="attemptTribulation()">
          â˜„ï¸ æ¸¡åŠ«çªç ´ï¼å¤©é›·æ»šæ»šè€Œæ¥ï¼
        </button>

        <!-- éŸ³ä¹ -->
        <div style="text-align:center;margin-top:15px;font-size:12px;color:#ccc;">
          <button onclick="toggleMusic()" id="musicBtn">ğŸ”Š å¼€å¯éŸ³ä¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è£…å¤‡è¯¦æƒ…å¼¹çª— -->
  <div class="modal" id="itemModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">è£…å¤‡è¯¦æƒ…</div>
      <div class="modal-body">
        <ul id="modalAttrs"></ul>
        <div id="setEffect" style="margin-top:10px;"></div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal()">å…³é—­</button>
        <button id="equipBtn" style="display:none;" onclick="confirmEquip()">è£…å¤‡</button>
        <button id="unequipBtn" style="display:none;" onclick="confirmUnequip()">å¸ä¸‹</button>
        <button id="enhanceBtn" style="display:none;" onclick="enhanceItem()">å¼ºåŒ–+1</button>
      </div>
    </div>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ -->
  <audio id="bgMusic" loop>
    <source src="https://cdn.jsdelivr.net/gh/mengzhuo/assets@main/xianxia-loop-soothing.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ==================== æ•°æ®å®šä¹‰ ====================
    const REALMS = ["ç‚¼æ°”æœŸ", "ç­‘åŸºæœŸ", "é‡‘ä¸¹æœŸ", "å…ƒå©´æœŸ", "åŒ–ç¥æœŸ", "åˆä½“æœŸ", "å¤§ä¹˜æœŸ", "æ¸¡åŠ«æœŸ"];
    const DUNGEONS = [
      { name: "å‡¡äººæ´ç©´", monster: "é‡çŒªå¦–|æ¯’è›‡æ€ª|å°é¬¼", dropBase: 1, bossChance: 0.05 },
      { name: "å¹½å†¥å¤å¢“", monster: "éª·é«…å…µ|å¹½é­‚|çŸ³åƒé¬¼", dropBase: 3, bossChance: 0.1 },
      { name: "ä¹å¹½é­”åŸŸ", monster: "ç‚é­”|å½±åˆºå®¢|è¡€å‚€å„¡", dropBase: 6, bossChance: 0.15 },
      { name: "æ··æ²Œç¦åŒº", monster: "è™šç©ºå…½|å •ç¥æ®‹å¿µ|æ··æ²Œé­”", dropBase: 10, bossChance: 0.2 }
    ];
    const GRADES = ["ç ´æŸ", "æ™®é€š", "ç²¾è‰¯", "ç¨€æœ‰", "å²è¯—", "ç¥è¯", "ä¼ è¯´"];
    const GRADE_MULTIPLIERS = [0.5, 1.0, 1.8, 2.8, 4.0, 6.0, 10.0];
    const GRADE_EXTRA_ATTR_RANGE = [[0,1], [1,1], [2,2], [2,3], [3,4], [4,5], [5,6]];

    const EXTRA_ATTRS = [
      { n: "ç”Ÿå‘½å€¼", min: 10, max: 50 },
      { n: "æš´å‡»ç‡(%)", min: 1.0, max: 5.0, f: true },
      { n: "æ”»å‡»é€Ÿåº¦", min: 1, max: 5 },
      { n: "é—ªé¿ç‡(%)", min: 1.0, max: 5.0, f: true },
      { n: "å¸è¡€ç‡(%)", min: 0.5, max: 3.0, f: true },
      { n: "ç ´ç”²ç‡(%)", min: 1.0, max: 4.0, f: true },
      { n: "çœŸä¼¤åŠ æˆ", min: 5, max: 15 }
    ];

    const EQUIP_SLOTS = ["æ­¦å™¨", "æŠ¤ç”²", "å¤´å† ", "æŠ¤è…¿", "é¥°å“"];
    const PREFIXES = ["é’å†¥", "ç„å†°", "é›·éœ†", "èµ¤ç„°", "æ˜Ÿè¾°", "æ··æ²Œ", "ç ´å†›", "å¤©ç½¡", "çµè™š", "ç´«ç”µ"];
    const SET_BONUSES = {
      "é’å†¥å¥—è£…": { count: 3, bonus: "æ”»å‡»åŠ›+15%ï¼Œå‡»è´¥å›è¡€5%" },
      "ç„å†°æˆ˜ç”²": { count: 3, bonus: "é˜²å¾¡åŠ›+20%ï¼Œé—ªé¿ç‡+5%" },
      "é›·éœ†ä¹‹æ€’": { count: 2, bonus: "æš´å‡»ç‡+10%ï¼Œæš´å‡»ä¼¤å®³+20%" },
      "å¤©ç½¡ç¥é“ ": { count: 4, bonus: "å‡ä¼¤20%ï¼Œåå¼¹10%ä¼¤å®³" },
      "çµè™šé“è¡£": { count: 2, bonus: "çµåŠ›æ¢å¤+30%ï¼ŒæŠ€èƒ½å†·å´-10%" }
    };

    const SKILL_BOOKS = [
      { name: "åŸºç¡€å‰‘æœ¯", type: "æ‹›å¼", desc: "æ™®æ”»é™„å¸¦é¢å¤–ä¼¤å®³", rarity: 1 },
      { name: "çœŸæ°”æŠ¤ä½“", type: "å¿ƒæ³•", desc: "æå‡é˜²å¾¡åŠ›", rarity: 2 },
      { name: "ä¸‡å‰‘å½’å®—", type: "ç»å­¦", desc: "ç¾¤ä½“é«˜ä¼¤", rarity: 4 },
      { name: "å¸æ˜Ÿå¤§æ³•", type: "ç§˜æœ¯", desc: "å¸è¡€+ç ´é˜²", rarity: 5 },
      { name: "å¤©å¤–é£ä»™", type: "ç»å­¦", desc: "å¿…æ€æŠ€ï¼Œæ— è§†é˜²å¾¡", rarity: 6 }
    ];

    const ACHIEVEMENTS = [
      { id: "kill_10", cond: (p) => p.killCount >= 10, name: "åˆå…¥æ±Ÿæ¹–", desc: "å‡»æ€10ä¸ªæ€ªç‰©" },
      { id: "mythical", cond: (p) => p.stats.hasMythical, name: "ç¥è¯é™ä¸´", desc: "è·å¾—ä¸€ä»¶ç¥è¯è£…å¤‡" },
      { id: "realm_4", cond: (p) => p.realm >= 4, name: "åŒ–ç¥å°Šè€…", desc: "çªç ´è‡³åŒ–ç¥æœŸ" }
    ];

    // ç©å®¶æ•°æ®
    const player = {
      level: 1,
      realm: 0,
      baseAttack: 10,
      baseDefense: 5,
      baseHealth: 100,
      attack: 10,
      defense: 5,
      health: 100,
      maxHealth: 100,
      mana: 100,
      maxMana: 100,
      killCount: 0,
      dungeon: 0,
      inventory: [],
      equipment: {},
      skills: [],
      gold: 200,
      lastSave: Date.now(),
      achievements: {},
      stats: { hasMythical: false },
      tribEnergy: 0,
      maxTribEnergy: 100,
      unspentPoints: 0,
      shopItems: []
    };

    for (let slot of EQUIP_SLOTS) player.equipment[slot] = null;
    for (let ach of ACHIEVEMENTS) player.achievements[ach.id] = false;

    let selectedItem = null;
    let currentTab = 'inventory';

    // å·¥å…·å‡½æ•°
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function roll(prob) {
      return Math.random() < prob;
    }

    function log(text, cls = "") {
      try {
        const logDiv = document.getElementById("combatLog");
        const entry = document.createElement("div");
        if (cls) entry.className = cls;
        entry.textContent = `[${new Date().toTimeString().slice(0,5)}] ${text}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      } catch (e) {
        console.error("æ—¥å¿—é”™è¯¯", e);
      }
    }

    // ==================== å¯åŠ¨æ¸¸æˆ ====================
    function startGame() {
      document.getElementById("guideOverlay").style.display = "none";
      document.getElementById("mainUI").style.display = "block";

      loadGame();
      bindEvents();
      refreshShop();
      setInterval(refreshShop, 3600000);
      updateUI();
      fight();
      setInterval(fight, 4000);
      setInterval(saveGame, 60000);

      log("âœ¨ æ–°ç”Ÿé“å‹ï¼Œè¸ä¸Šé€†å¤©ä¹‹è·¯ï¼");
    }

    function bindEvents() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = function () {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('#tab-inventory, #tab-equips, #tab-shop, #tab-skills').forEach(el => el.style.display = 'none');
          document.getElementById(`tab-${this.getAttribute('data-tab')}`).style.display = 'block';
        };
      });

      const sel = document.getElementById("dungeonSelect");
      sel.onchange = function () {
        player.dungeon = parseInt(this.value);
        log(`ğŸšª åˆ‡æ¢å‰¯æœ¬ï¼š${DUNGEONS[player.dungeon].name}`);
      };
    }

    // ==================== æˆ˜æ–—ç³»ç»Ÿ ====================
    function fight() {
      const d = DUNGEONS[player.dungeon];
      const names = d.monster.split("|");
      let name = names[randInt(0, names.length - 1)];
      const isBoss = roll(d.bossChance);
      const isElite = roll(0.15);

      if (isBoss) name = `ã€å¤©åŠ«${name}Â·BOSSã€‘`;
      else if (isElite) name = `ã€æš—å½±${name}Â·ç²¾è‹±ã€‘`;

      const monsterLevel = player.dungeon + (isBoss ? 3 : isElite ? 2 : 1);
      const monsterAtk = randInt(8, 12) * monsterLevel;
      const monsterDef = randInt(3, 6) * monsterLevel;
      const monsterHp = randInt(50, 80) * monsterLevel;

      log(`ğŸ‘¹ é­é‡ ${name}ï¼ˆLv.${monsterLevel}ï¼‰ï¼`);

      setTimeout(() => {
        const damageToMonster = Math.max(1, player.attack - monsterDef / 2);
        log(`âš”ï¸ ä½ å¯¹ ${name} é€ æˆ ${damageToMonster} ç‚¹ä¼¤å®³ï¼`, "success");

        // æ‰è½é€»è¾‘
        if (roll(0.8)) {
          const dropType = roll(0.1) ? 'skill' : 'equip';
          if (dropType === 'skill') {
            const book = SKILL_BOOKS[randInt(0, SKILL_BOOKS.length - 1)];
            if (roll(book.rarity * 0.1)) {
              player.inventory.push({ ...book, id: Date.now(), type: 'skill' });
              log(`ğŸ“˜ ã€${name}ã€‘æ‰è½æŠ€èƒ½ä¹¦ï¼šã€Š${book.name}ã€‹`, `grade-${book.rarity}`);
            }
          } else {
            const gradeBoost = isBoss ? 2 : isElite ? 1 : 0;
            const equipment = createEquipment(player.dungeon + gradeBoost);
            if (equipment.gradeIndex >= 5) player.stats.hasMythical = true;

            if (player.inventory.length < 50) {
              const minGrade = parseInt(document.getElementById("minGradeForPickup").value);
              const autoPick = document.getElementById("autoPickup").checked;

              if (!autoPick || equipment.gradeIndex >= minGrade) {
                player.inventory.push(equipment);
                log(`ğŸ ã€${name}ã€‘æ‰è½æ³•å®ï¼šã€${equipment.grade}ã€‘${equipment.name}`, `grade-${equipment.gradeIndex}`);
              }
            }
          }
        } else {
          const gold = randInt(1, 5) * (player.dungeon + 1) * (isBoss ? 3 : isElite ? 2 : 1);
          player.gold += gold;
          log(`ğŸ’° ç¼´è·çµçŸ³ Ã—${gold}`);
        }

        player.killCount++;
        player.tribEnergy = Math.min(player.maxTribEnergy, player.tribEnergy + 1);
        player.mana = Math.min(player.maxMana, player.mana + 15);

        if (player.tribEnergy >= player.maxTribEnergy && !player.inTribulation) {
          player.inTribulation = true;
          log("âš¡ èƒ½é‡å·²æ»¡ï¼å¯å°è¯•æ¸¡åŠ«çªç ´ï¼", "upgrade");
          document.getElementById("btnTrib").style.display = "block";
        }

        checkAchievements();
        updateUI();
      }, 800);
    }

    // ==================== åˆ›å»ºè£…å¤‡ ====================
    function createEquipment(baseGrade) {
      let gradeIndex = baseGrade + randInt(-1, 2);
      gradeIndex = Math.max(0, Math.min(6, gradeIndex));

      const multiplier = GRADE_MULTIPLIERS[gradeIndex] * (1 + baseGrade * 0.4);
      const type = EQUIP_SLOTS[randInt(0, 4)];
      const prefix = PREFIXES[randInt(0, PREFIXES.length - 1)];

      const equip = {
        id: Date.now() + randInt(1, 1000),
        grade: GRADES[gradeIndex],
        gradeIndex: gradeIndex,
        type: type,
        name: `${prefix}Â·${type}`,
        baseAttributes: {},
        extraAttributes: {},
        enhanceLevel: 0,
        setId: ""
      };

      // å¥—è£…åˆ¤å®š
      if (gradeIndex >= 4 && roll(0.3)) {
        const sets = Object.keys(SET_BONUSES);
        equip.setId = sets[randInt(0, sets.length - 1)];
        equip.setName = equip.setId;
      }

      const baseAttack = Math.round(5 * multiplier);
      const baseDefense = Math.round(3 * multiplier);
      if (type === "æ­¦å™¨") equip.baseAttributes["æ”»å‡»åŠ›"] = baseAttack;
      else equip.baseAttributes["é˜²å¾¡åŠ›"] = baseDefense;

      const [minE, maxE] = GRADE_EXTRA_ATTR_RANGE[gradeIndex];
      const numExtra = randInt(minE, maxE);
      const attrsPool = [...EXTRA_ATTRS];
      for (let i = 0; i < numExtra && attrsPool.length > 0; i++) {
        const idx = randInt(0, attrsPool.length - 1);
        const attr = attrsPool.splice(idx, 1)[0];
        const value = attr.f ? (Math.random() * (attr.max - attr.min) + attr.min).toFixed(1) : randInt(attr.min, attr.max);
        equip.extraAttributes[attr.n] = value;
      }

      return equip;
    }

    // ==================== UI æ›´æ–° ====================
    function updateUI() {
      // è§’è‰²çŠ¶æ€
      const setCounts = {};
      for (const eq of Object.values(player.equipment)) {
        if (eq && eq.setId) {
          setCounts[eq.setId] = (setCounts[eq.setId] || 0) + 1;
        }
      }

      let setBonus = "";
      for (const setId in setCounts) {
        const bonus = SET_BONUSES[setId];
        if (setCounts[setId] >= bonus.count) {
          setBonus += `<div class="grade-5">ã€${setId}ã€‘${bonus.bonus}</div>`;
        }
      }

      player.attack = player.baseAttack + getEquipStat("æ”»å‡»åŠ›");
      player.defense = player.baseDefense + getEquipStat("é˜²å¾¡åŠ›");
      player.maxHealth = player.baseHealth + getEquipStat("ç”Ÿå‘½å€¼");
      if (player.health > player.maxHealth) player.health = player.maxHealth;

      document.getElementById("playerStats").innerHTML = `
        <strong>é“å·</strong>: æ— åé“å‹<br/>
        <strong>å¢ƒç•Œ</strong>: ã€${REALMS[player.realm]}ã€‘<br/>
        <div class="stat-row"><span>æ”»å‡»åŠ›</span><span>${player.attack}</span></div>
        <div class="stat-row"><span>é˜²å¾¡åŠ›</span><span>${player.defense}</span></div>
        <div class="stat-row"><span>ç”Ÿå‘½</span><span>${player.health}/${player.maxHealth}</span></div>
        <div class="bar"><div class="fill hp-fill" style="width:${(player.health/player.maxHealth)*100}%"></div></div>
        <div class="stat-row"><span>çµåŠ›</span><span>${player.mana}/${player.maxMana}</span></div>
        <div class="bar"><div class="fill mp-fill" style="width:${(player.mana/player.maxMana)*100}%"></div></div>
        <div class="stat-row"><span>çµçŸ³</span><span>${player.gold}</span></div>
        <div class="stat-row"><span>æ€æˆ®æ•°</span><span>${player.killCount}</span></div>
        ${setBonus}
        ${player.unspentPoints > 0 ? `<div class="grade-6">âš ï¸ æœ‰ ${player.unspentPoints} ç‚¹æœªåˆ†é…å±æ€§ç‚¹ï¼</div>` : ""}
      `;

      // æŠ€èƒ½å†·å´
      const skill = player.skills.skill1 || { remaining: 0, cd: 8, cost: 30 };
      const btn = document.getElementById("skillBtn");
      if (skill.remaining > 0) {
        btn.textContent = `ğŸ’¥ ä¸‡å‰‘å½’å®—ï¼ˆ${skill.remaining}sï¼‰`;
        btn.disabled = true;
      } else {
        btn.textContent = `ğŸ’¥ ä¸‡å‰‘å½’å®—ï¼ˆæ¶ˆè€—${skill.cost}çµåŠ›ï¼‰`;
        btn.disabled = false;
      }

      // å‰¯æœ¬
      const sel = document.getElementById("dungeonSelect");
      sel.innerHTML = "";
      DUNGEONS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = d.name;
        if (i === player.dungeon) opt.selected = true;
        sel.appendChild(opt);
      });
      document.getElementById("dungeonInfo").innerHTML = `éš¾åº¦ï¼š${DUNGEONS[player.dungeon].dropBase}å€ | BOSSæ¦‚ç‡ï¼š${(DUNGEONS[player.dungeon].bossChance*100).toFixed(1)}%`;

      // èƒŒåŒ…
      const invList = document.getElementById("inventoryList");
      invList.innerHTML = "";
      [...player.inventory]
        .sort((a, b) => b.gradeIndex - a.gradeIndex)
        .slice(0, 20)
        .forEach(eq => {
          const div = document.createElement("div");
          div.className = `item grade-${eq.type === 'skill' ? 6 : eq.gradeIndex}`;
          div.innerHTML = eq.type === 'skill' ? `ğŸ“˜ã€Š${eq.name}ã€‹(${eq.type})` : `${eq.name}${eq.enhanceLevel > 0 ? `[+${eq.enhanceLevel}]` : ''}`;
          div.onclick = () => showItemDetail(eq);
          invList.appendChild(div);
        });

      // è£…å¤‡æ 
      const es = document.getElementById("equipslot");
      es.innerHTML = "";
      for (const slot of EQUIP_SLOTS) {
        const eq = player.equipment[slot];
        const item = document.createElement("div");
        item.className = "equip-slot";
        if (eq) {
          item.innerHTML = `<span class="grade-${eq.gradeIndex}">${slot}</span>ï¼š${eq.name}${eq.enhanceLevel > 0 ? `[+${eq.enhanceLevel}]` : ''}`;
          item.onclick = () => showItemDetail(eq);
          item.style.cursor = "pointer";
        } else {
          item.innerHTML = `<span>ç©º</span>`;
          item.style.opacity = 0.5;
        }
        es.appendChild(item);
      }

      // å•†åº—
      const shopDiv = document.getElementById("shopItems");
      shopDiv.innerHTML = "";
      player.shopItems.forEach((item, i) => {
        const price = (item.gradeIndex + 1) * 50 * (1 + player.realm * 0.5);
        const card = document.createElement("div");
        card.className = `equip-card grade-${item.gradeIndex}`;
        card.innerHTML = `
          <b>${item.name}</b><br>
          ${Object.entries(item.baseAttributes).map(([k,v])=>`${k}+${v}`).join(", ")}<br>
          <small>å”®ä»·ï¼š${price} çµçŸ³</small>
        `;
        card.onclick = () => buyFromShop(i);
        shopDiv.appendChild(card);
      });

      // æŠ€èƒ½åˆ—è¡¨
      const skillDiv = document.getElementById("skillList");
      skillDiv.innerHTML = player.skills.length === 0 ? "<div>æš‚æ— æŠ€èƒ½</div>" : "";
      player.skills.forEach(skill => {
        const item = document.createElement("div");
        item.className = "skill-item";
        item.innerHTML = `<b>${skill.name}</b> (${skill.type})<br><small>${skill.desc}</small>`;
        skillDiv.appendChild(item);
      });

      // æ¸¡åŠ«èƒ½é‡æ¡
      const progressText = document.getElementById("tribProgress");
      const energyFill = document.getElementById("energyFill");
      progressText.textContent = `${player.tribEnergy}/${player.maxTribEnergy}`;
      energyFill.style.width = `${(player.tribEnergy / player.maxTribEnergy) * 100}%`;
      document.getElementById("btnTrib").style.display = player.inTribulation ? "block" : "none";
    }

    // è·å–è£…å¤‡æ€»å±æ€§
    function getEquipStat(key) {
      let sum = 0;
      for (const eq of Object.values(player.equipment)) {
        if (eq) {
          if (eq.baseAttributes[key]) sum += eq.baseAttributes[key];
          if (eq.extraAttributes[key]) sum += parseFloat(eq.extraAttributes[key]);
          sum += eq.enhanceLevel * (key === "æ”»å‡»åŠ›" ? 3 : key === "é˜²å¾¡åŠ›" ? 2 : key === "ç”Ÿå‘½å€¼" ? 10 : 0);
        }
      }
      return sum;
    }

    // ==================== è£…å¤‡ç³»ç»Ÿ ====================
    function showItemDetail(item) {
      selectedItem = item;
      document.getElementById("modalTitle").textContent = item.name + (item.enhanceLevel > 0 ? `[+${item.enhanceLevel}]` : '');
      const ul = document.getElementById("modalAttrs");
      ul.innerHTML = "";

      if (item.type === 'skill') {
        ul.innerHTML = `<li>ç±»å‹ï¼š${item.type}</li><li>æ•ˆæœï¼š${item.desc}</li>`;
        document.getElementById("setEffect").innerHTML = "";
        document.getElementById("equipBtn").style.display = "none";
        document.getElementById("unequipBtn").style.display = "none";
        document.getElementById("enhanceBtn").style.display = "none";
      } else {
        for (let k in item.baseAttributes) {
          const li = document.createElement("li");
          li.textContent = `${k}: +${item.baseAttributes[k]}`;
          ul.appendChild(li);
        }
        for (let k in item.extraAttributes) {
          const li = document.createElement("li");
          li.textContent = `${k}: +${item.extraAttributes[k]}`;
          ul.appendChild(li);
        }
        if (item.setId) {
          const se = document.getElementById("setEffect");
          se.innerHTML = `<span style="color:#ff8c00">ğŸ“¦ å¥—è£…ï¼š${item.setName}</span>`;
        } else {
          document.getElementById("setEffect").innerHTML = "";
        }
        if (item.enhanceLevel > 0) {
          const li = document.createElement("li");
          li.style.color = "#d4af37";
          li.textContent = `âœ¨ å¼ºåŒ–ï¼š+${item.enhanceLevel}`;
          ul.appendChild(li);
        }

        const equipBtn = document.getElementById("equipBtn");
        const unequipBtn = document.getElementById("unequipBtn");
        const currentEq = player.equipment[item.type];

        if (currentEq && currentEq.id === item.id) {
          equipBtn.style.display = "none";
          unequipBtn.style.display = "inline-block";
        } else {
          equipBtn.style.display = "inline-block";
          unequipBtn.style.display = "none";
        }
        document.getElementById("enhanceBtn").style.display = "inline-block";
      }

      document.getElementById("itemModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("itemModal").style.display = "none";
      selectedItem = null;
    }

    function confirmEquip() {
      if (!selectedItem || selectedItem.type === 'skill') return;
      const item = player.inventory.find(eq => eq.id === selectedItem.id);
      if (!item) return;

      const old = player.equipment[item.type];
      if (old) player.inventory.push(old);

      player.equipment[item.type] = item;
      player.inventory = player.inventory.filter(eq => eq.id !== item.id);
      log(`âš”ï¸ è£…å¤‡æ³•å®ï¼š${item.name}`, `grade-${item.gradeIndex}`);
      closeModal();
      updateUI();
    }

    function confirmUnequip() {
      if (!selectedItem) return;
      const item = player.equipment[selectedItem.type];
      if (!item) return;

      player.inventory.push(item);
      player.equipment[selectedItem.type] = null;
      log(`ğŸ§¼ å¸ä¸‹æ³•å®ï¼š${item.name}`);
      closeModal();
      updateUI();
    }

    function enhanceItem() {
      if (!selectedItem || selectedItem.type === 'skill') return;
      const successRate = selectedItem.enhanceLevel < 5 ? 0.8 :
                          selectedItem.enhanceLevel < 8 ? 0.5 :
                          selectedItem.enhanceLevel < 10 ? 0.3 : 0.1;

      log(`ğŸ”¨ å¼€å§‹å¼ºåŒ–ã€${selectedItem.name}ã€‘... æˆåŠŸç‡ ${(successRate*100).toFixed(0)}%`);

      setTimeout(() => {
        if (roll(successRate)) {
          selectedItem.enhanceLevel++;
          log(`âœ… å¼ºåŒ–æˆåŠŸï¼å½“å‰ [+${selectedItem.enhanceLevel}]`, "grade-6");
        } else {
          if (roll(0.3) && selectedItem.enhanceLevel > 0) {
            log(`âŒ å¼ºåŒ–å¤±è´¥ï¼Œè£…å¤‡ç ´ç¢ï¼`, "fail");
            player.inventory = player.inventory.filter(eq => eq.id !== selectedItem.id);
          } else {
            log(`âŒ å¼ºåŒ–å¤±è´¥ï¼Œç­‰çº§ä¸å˜`);
          }
        }
        closeModal();
        updateUI();
      }, 1000);
    }

    // ==================== å•†åº— ====================
    function refreshShop() {
      player.shopItems = [];
      for (let i = 0; i < 3; i++) {
        const grade = Math.min(6, player.realm + randInt(0, 2));
        const equipment = createEquipment(grade);
        equipment.price = (grade + 1) * 50 * (1 + player.realm * 0.5);
        player.shopItems.push(equipment);
      }
      log("ğŸ›’ å•†åº—å·²åˆ·æ–°ï¼");
      updateUI();
    }

    function buyFromShop(index) {
      const item = player.shopItems[index];
      if (player.gold < item.price) {
        log("âŒ çµçŸ³ä¸è¶³ï¼");
        return;
      }
      player.gold -= item.price;
      player.inventory.push(item);
      player.shopItems.splice(index, 1);
      log(`ğŸ‰ è´­ä¹°æˆåŠŸï¼š${item.name}`);
      updateUI();
    }

    // ==================== æŠ€èƒ½ ====================
    function useSkill() {
      const skill = player.skills.skill1 || { remaining: 0, cd: 8, cost: 30 };
      if (skill.remaining > 0) return;
      if (player.mana < skill.cost) {
        log("âŒ çµåŠ›ä¸è¶³ï¼");
        return;
      }

      player.mana -= skill.cost;
      log("ğŸ’¥ é‡Šæ”¾ã€ä¸‡å‰‘å½’å®—ã€‘ï¼å¯¹å…¨åœºæ•Œäººé€ æˆå·¨é¢ä¼¤å®³ï¼", "grade-6");

      setTimeout(() => {
        log("ğŸ”¥ æ–½å±•ç¥é€šï¼Œç»éªŒ+10ï¼ŒçµçŸ³+5");
        player.killCount += 1;
        player.gold += 5;
        checkAchievements();
      }, 500);

      skill.remaining = skill.cd;
      const timer = setInterval(() => {
        skill.remaining--;
        if (skill.remaining <= 0) clearInterval(timer);
        updateUI();
      }, 1000);

      updateUI();
    }

    // ==================== åŠŸèƒ½å‡½æ•° ====================
    function discardAll() {
      const count = player.inventory.length;
      player.inventory = [];
      log(`ğŸ—‘ï¸ æ— æƒ…ä¸¢å¼ƒ ${count} ä»¶æ³•å®ï¼`);
      updateUI();
    }

    function sellAll() {
      const minSell = parseInt(prompt("å‡ºå”®ä½äºå“ªä¸ªå“è´¨ï¼Ÿ\n0=ç ´æŸ,1=æ™®é€š...", "1"));
      if (isNaN(minSell)) return;

      const filtered = player.inventory.filter(eq => eq.type !== 'skill' && eq.gradeIndex < minSell);
      const count = filtered.length;
      const gold = filtered.reduce((sum, eq) => sum + (eq.gradeIndex + 1) * 10, 0);
      player.gold += gold;
      player.inventory = player.inventory.filter(eq => !(eq.type !== 'skill' && eq.gradeIndex < minSell));
      log(`ğŸ’° å‡ºå”® ${count} ä»¶æ³•å®ï¼Œè·å¾—çµçŸ³ Ã—${gold}`);
      updateUI();
    }

    function toggleMusic() {
      const btn = document.getElementById("musicBtn");
      if (bgMusic.paused) {
        bgMusic.play().then(() => btn.textContent = "ğŸ”‡ å…³é—­éŸ³ä¹").catch(() => alert("è¯·å…ˆç‚¹å‡»é¡µé¢"));
      } else {
        bgMusic.pause();
        btn.textContent = "ğŸ”Š å¼€å¯éŸ³ä¹";
      }
    }

    function attemptTribulation() {
      const successRate = 0.7 + player.realm * 0.05;
      log(`ğŸ”¥ æ¸¡åŠ«å¼€å§‹ï¼æˆåŠŸç‡çº¦ ${(successRate*100).toFixed(0)}%...`);

      setTimeout(() => {
        if (roll(successRate)) {
          player.realm++;
          player.tribEnergy = 0;
          player.inTribulation = false;
          player.unspentPoints += 5;
          player.maxTribEnergy += 20;
          log(`ğŸ’¥ æˆåŠŸæ¸¡åŠ«ï¼è¿›å…¥ã€${REALMS[player.realm]}ã€‘ï¼è·å¾—5ç‚¹å±æ€§ç‚¹`, "upgrade");
          document.getElementById("btnTrib").style.display = "none";
          refreshShop();
        } else {
          player.tribEnergy = Math.max(0, player.tribEnergy - 20);
          log(`âŒ æ¸¡åŠ«å¤±è´¥ï¼èƒ½é‡å€’é€€ï¼`, "fail");
        }
        updateUI();
      }, 1500);
    }

    function checkAchievements() {
      ACHIEVEMENTS.forEach(ach => {
        if (!player.achievements[ach.id] && ach.cond(player)) {
          player.achievements[ach.id] = true;
          log(`ğŸ† è§£é”æˆå°±ï¼šã€${ach.name}ã€‘â€”â€” ${ach.desc}`, "success");
        }
      });
    }

    function saveGame() {
      try {
        localStorage.setItem("immortal_idle_save", JSON.stringify(player));
      } catch (e) {}
    }

    function loadGame() {
      try {
        const save = localStorage.getItem("immortal_idle_save");
        if (save) Object.assign(player, JSON.parse(save));
      } catch (e) {}
    }
  </script>
</body>
</html>
