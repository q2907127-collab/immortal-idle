<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é€†å¤©æŒ‚æœºï¼šä¸€å‰‘é£å‡</title>

  <!-- å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

  <style>
    @font-face {
      font-family: 'LXGW';
      src: url('https://cdn.jsdelivr.net/gh/lxgw/LxgwWenkaiWebFont@latest/fonts/LXGWWenKai-Regular.woff2') format('woff2');
      font-display: swap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'LXGW', 'Ma Shan Zheng', 'Microsoft YaHei', sans-serif;
      background: url('https://cdn.jsdelivr.net/gh/mengzhuo/assets@main/xianxia-bg-ai-v2.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #e6e6e6;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .main-panel {
      flex: 3;
    }

    .sidebar {
      flex: 2;
      background: rgba(15, 25, 45, 0.7);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(100, 150, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      font-size: 2.2em;
      color: #d4af37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .stats {
      background: rgba(0, 0, 0, 0.4);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      line-height: 2;
      border-left: 5px solid #5ce6e6;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
    }

    .log {
      height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      padding: 14px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid rgba(100, 150, 255, 0.2);
    }

    .log div {
      margin-bottom: 6px;
      word-break: break-word;
    }

    button {
      background: #1e90ff;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 5px 2px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    button:hover {
      background: #3cb0ff;
      transform: scale(1.03);
    }

    button.red { background: #e94560; }
    button.green { background: #32cd32; }
    button.orange { background: #ff8c00; color: #000; }
    button.gray { background: #888; }

    button.btn-big {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
    }

    /* å“è´¨é¢œè‰² */
    .grade-0 { color: #aaa; }
    .grade-1 { color: white; }
    .grade-2 { color: #32cd32; }
    .grade-3 { color: #1e90ff; }
    .grade-4 { color: #9932cc; }
    .grade-5 { color: #ff8c00; }
    .grade-6 { color: #d4af37; font-weight: bold; }

    /* åˆ—è¡¨é¡¹ */
    .item-list {
      height: 120px;
      overflow-y: auto;
      margin-top: 10px;
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 6px;
      padding: 5px;
    }

    .item {
      padding: 8px;
      margin-top: 4px;
      background: rgba(30, 40, 80, 0.5);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .item:hover {
      background: rgba(60, 90, 160, 0.6);
      transform: translateX(5px);
    }

    /* å¼¹çª— */
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
    }

    .modal-content {
      background: rgba(20, 30, 60, 0.95);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      border: 1px solid #5ce6e6;
      color: white;
    }

    .modal-header {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #ff8c00;
    }

    .modal-body ul {
      list-style: none;
    }

    .modal-body li {
      margin: 8px 0;
      padding-left: 15px;
      position: relative;
    }

    .modal-body li:before {
      content: "âœ¦";
      position: absolute;
      left: 0;
      color: #5ce6e6;
    }

    .modal-footer {
      text-align: right;
      margin-top: 15px;
    }

    /* è£…å¤‡æ  */
    .equip-slot {
      padding: 6px;
      margin: 4px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      font-size: 13px;
    }

    .equip-slot span {
      color: #ccc;
    }

    /* tab æ ‡ç­¾é¡µ */
    .tabs {
      display: flex;
      margin-bottom: 10px;
    }

    .tab {
      padding: 8px 16px;
      background: rgba(100, 100, 150, 0.3);
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: #1e90ff;
      color: white;
    }

    /* è“„èƒ½æ¡ */
    .energy-bar {
      width: 100%;
      height: 12px;
      background: #333;
      border-radius: 6px;
      margin: 8px 0;
      overflow: hidden;
    }

    .energy-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff5c8d, #ff8c00);
      transition: width 0.3s;
    }
  </style>
</head>
<body>

  <!-- å¯åŠ¨å¼•å¯¼é¡µ -->
  <div class="guide-overlay" id="guideOverlay">
    <h2>ğŸŒŒ é€†å¤©æŒ‚æœºï¼šä¸€å‰‘é£å‡</h2>
    <p>ä½ æœ¬æ˜¯å‡¡äººï¼Œå´åœ¨å¤æ´ä¸­å¾—ä¸€æ®‹å·â€”â€”ã€Šæ··æ²Œåå¤©è¯€ã€‹ã€‚</p>
    <p>ä»æ­¤è¸ä¸Šé€†å¤©ä¿®è¡Œä¹‹è·¯ï¼Œæ–©å¦–é™¤é­”ï¼Œç‚¼å™¨ç‚¼ä¸¹ï¼Œç»ˆå°†æ‰“ç ´æ¡æ¢ï¼Œé£å‡æˆä»™ï¼</p>
    <p>é•‡å‹ä¸‡æ—ï¼Œå”¯æˆ‘ç‹¬å°Šï¼</p>
    <button class="btn btn-big orange" onclick="startGame()">âœ¨ ç‚¹æ­¤å¼€è„‰ï¼Œè¸å…¥ä¿®çœŸç•Œ</button>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainUI" style="display:none;">
    <h1>ã€Œé€†å¤©æŒ‚æœºã€ä¸€å‰‘é£å‡</h1>
    <div class="container">
      <div class="main-panel">
        <div class="stats" id="playerStats">åŠ è½½ä¸­...</div>
        <div class="log" id="combatLog"></div>
      </div>

      <div class="sidebar">
        <!-- Tab åˆ‡æ¢ -->
        <div class="tabs">
          <div class="tab active" data-tab="inventory">ğŸ’ èƒŒåŒ…</div>
          <div class="tab" data-tab="equips">âš”ï¸ è£…å¤‡</div>
          <div class="tab" data-tab="achievements">ğŸ† æˆå°±</div>
        </div>

        <!-- èƒŒåŒ… -->
        <div id="tab-inventory">
          <div>
            <label><input type="checkbox" id="autoPickup" checked> è‡ªåŠ¨æ‹¾å–</label>
            <select id="minGradeForPickup">
              <option value="0">ä¸å±è”½</option>
              <option value="1">æ™®é€šåŠä»¥ä¸Š</option>
              <option value="2">ç²¾è‰¯åŠä»¥ä¸Š</option>
              <option value="3">ç¨€æœ‰åŠä»¥ä¸Š</option>
              <option value="4">å²è¯—åŠä»¥ä¸Š</option>
              <option value="5">ç¥è¯åŠä»¥ä¸Š</option>
            </select>
          </div>
          <button onclick="discardAll()" class="red">ğŸ—‘ï¸ ä¸¢å¼ƒå…¨éƒ¨</button>
          <button onclick="sellAll()" class="green">ğŸ’° å‡ºå”®åƒåœ¾</button>
          <div class="item-list" id="inventoryList"></div>
        </div>

        <!-- è£…å¤‡æ  -->
        <div id="tab-equips" style="display:none;">
          <div id="equipslot"></div>
        </div>

        <!-- æˆå°± -->
        <div id="tab-achievements" style="display:none;">
          <div id="achievements"></div>
        </div>

        <!-- å‰¯æœ¬é€‰æ‹© -->
        <h3>ğŸ¯ å½“å‰å‰¯æœ¬</h3>
        <select id="dungeonSelect"></select>
        <div id="dungeonInfo"></div>

        <!-- æ¸¡åŠ«å° -->
        <h3>âš¡ æ¸¡åŠ«å°</h3>
        <div>å½“å‰è¿›åº¦ï¼š<span id="tribProgress">0</span>/100</div>
        <div class="energy-bar"><div class="energy-fill" id="energyFill"></div></div>
        <button id="btnTrib" class="btn-big orange" style="display:none;" onclick="attemptTribulation()">
          â˜„ï¸ æ¸¡åŠ«çªç ´ï¼å¤©é›·æ»šæ»šè€Œæ¥ï¼
        </button>

        <!-- éŸ³ä¹ -->
        <div style="text-align:center;margin-top:15px;font-size:12px;color:#ccc;">
          <button onclick="toggleMusic()" id="musicBtn">ğŸ”Š å¼€å¯éŸ³ä¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è£…å¤‡è¯¦æƒ…å¼¹çª— -->
  <div class="modal" id="itemModal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">è£…å¤‡è¯¦æƒ…</div>
      <div class="modal-body">
        <ul id="modalAttrs"></ul>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal()">å…³é—­</button>
        <button id="equipBtn" style="display:none;" onclick="confirmEquip()">è£…å¤‡</button>
        <button id="unequipBtn" style="display:none;" onclick="confirmUnequip()">å¸ä¸‹</button>
      </div>
    </div>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ -->
  <audio id="bgMusic" loop>
    <source src="https://cdn.jsdelivr.net/gh/mengzhuo/assets@main/xianxia-loop-soothing.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ==================== æ•°æ®å®šä¹‰ ====================
    const REALMS = ["ç‚¼æ°”æœŸ", "ç­‘åŸºæœŸ", "é‡‘ä¸¹æœŸ", "å…ƒå©´æœŸ", "åŒ–ç¥æœŸ", "åˆä½“æœŸ", "å¤§ä¹˜æœŸ", "æ¸¡åŠ«æœŸ"];
    const DUNGEONS = [
      { name: "å‡¡äººæ´ç©´", monster: "é‡çŒªå¦–|æ¯’è›‡æ€ª|å°é¬¼", dropBase: 1, bossChance: 0.05 },
      { name: "å¹½å†¥å¤å¢“", monster: "éª·é«…å…µ|å¹½é­‚|çŸ³åƒé¬¼", dropBase: 3, bossChance: 0.1 },
      { name: "ä¹å¹½é­”åŸŸ", monster: "ç‚é­”|å½±åˆºå®¢|è¡€å‚€å„¡", dropBase: 6, bossChance: 0.15 },
      { name: "æ··æ²Œç¦åŒº", monster: "è™šç©ºå…½|å •ç¥æ®‹å¿µ|æ··æ²Œé­”", dropBase: 10, bossChance: 0.2 }
    ];
    const GRADES = ["ç ´æŸ", "æ™®é€š", "ç²¾è‰¯", "ç¨€æœ‰", "å²è¯—", "ç¥è¯", "ä¼ è¯´"];
    const GRADE_MULTIPLIERS = [0.5, 1.0, 1.8, 2.8, 4.0, 6.0, 10.0];
    const GRADE_EXTRA_ATTR_RANGE = [[0,1], [1,1], [2,2], [2,3], [3,4], [4,5], [5,6]];

    const EXTRA_ATTRS = [
      { n: "ç”Ÿå‘½å€¼", min: 10, max: 50 },
      { n: "æš´å‡»ç‡(%)", min: 1.0, max: 5.0, f: true },
      { n: "æ”»å‡»é€Ÿåº¦", min: 1, max: 5 },
      { n: "é—ªé¿ç‡(%)", min: 1.0, max: 5.0, f: true },
      { n: "å¸è¡€ç‡(%)", min: 0.5, max: 3.0, f: true },
      { n: "ç ´ç”²ç‡(%)", min: 1.0, max: 4.0, f: true },
      { n: "çœŸä¼¤åŠ æˆ", min: 5, max: 15 }
    ];

    const EQUIP_SLOTS = ["æ­¦å™¨", "æŠ¤ç”²", "å¤´å† ", "æŠ¤è…¿", "é¥°å“"];

    const ACHIEVEMENTS = [
      { id: "kill_10", cond: (p) => p.killCount >= 10, name: "åˆå…¥æ±Ÿæ¹–", desc: "å‡»æ€10ä¸ªæ€ªç‰©" },
      { id: "kill_100", cond: (p) => p.killCount >= 100, name: "æ€æˆ®æˆæ€§", desc: "å‡»æ€100ä¸ªæ€ªç‰©" },
      { id: "mythical", cond: (p) => p.stats.hasMythical, name: "ç¥è¯é™ä¸´", desc: "è·å¾—ä¸€ä»¶ç¥è¯è£…å¤‡" },
      { id: "legend", cond: (p) => p.stats.hasLegend, name: "ä¸‡å¤å”¯ä¸€", desc: "è·å¾—ä¼ è¯´æ³•å®" },
      { id: "realm_4", cond: (p) => p.realm >= 4, name: "åŒ–ç¥å°Šè€…", desc: "çªç ´è‡³åŒ–ç¥æœŸ" },
      { id: "gold_1000", cond: (p) => p.gold >= 1000, name: "å¯Œå¯æ•Œå›½", desc: "æ‹¥æœ‰1000çµçŸ³" }
    ];

    // ç©å®¶æ•°æ®
    const player = {
      level: 1,
      realm: 0,
      attack: 10,
      defense: 5,
      health: 100,
      killCount: 0,
      dungeon: 0,
      inventory: [],
      equipment: {},
      skills: [],
      gold: 0,
      lastSave: Date.now(),
      achievements: {},
      stats: { hasMythical: false, hasLegend: false },
      tribEnergy: 0, // æ¸¡åŠ«èƒ½é‡
      maxTribEnergy: 100
    };

    for (let slot of EQUIP_SLOTS) player.equipment[slot] = null;
    for (let ach of ACHIEVEMENTS) player.achievements[ach.id] = false;

    // DOM å…ƒç´ ç¼“å­˜
    const bgMusic = document.getElementById("bgMusic");
    let selectedItem = null;
    let currentTab = 'inventory';

    // å·¥å…·å‡½æ•°
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function roll(prob) {
      return Math.random() < prob;
    }

    function log(text, cls = "") {
      try {
        const logDiv = document.getElementById("combatLog");
        const entry = document.createElement("div");
        if (cls) entry.className = cls;
        entry.textContent = `[${new Date().toTimeString().slice(0,5)}] ${text}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      } catch (e) {
        console.error("æ—¥å¿—é”™è¯¯", e);
      }
    }

    // ==================== å¯åŠ¨æ¸¸æˆ ====================
    function startGame() {
      document.getElementById("guideOverlay").style.display = "none";
      document.getElementById("mainUI").style.display = "block";

      loadGame();
      bindEvents();
      updateUI();
      fight();
      setInterval(fight, 3000);
      setInterval(saveGame, 60000);

      log("âœ¨ æ–°ç”Ÿé“å‹ï¼Œè¸ä¸Šé€†å¤©ä¹‹è·¯ï¼");
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    function bindEvents() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = function () {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('#tab-inventory, #tab-equips, #tab-achievements').forEach(el => el.style.display = 'none');
          document.getElementById(`tab-${this.getAttribute('data-tab')}`).style.display = 'block';
        };
      });

      const sel = document.getElementById("dungeonSelect");
      sel.onchange = function () {
        player.dungeon = parseInt(this.value);
        log(`ğŸšª åˆ‡æ¢å‰¯æœ¬ï¼š${DUNGEONS[player.dungeon].name}`);
      };
    }

    // ==================== æˆ˜æ–—ç³»ç»Ÿ ====================
    function fight() {
      const d = DUNGEONS[player.dungeon];
      const names = d.monster.split("|");
      let name = names[randInt(0, names.length - 1)];
      const isBoss = roll(d.bossChance);
      const isElite = roll(0.15);

      if (isBoss) name = `ã€å¤©åŠ«${name}Â·BOSSã€‘`;
      else if (isElite) name = `ã€æš—å½±${name}Â·ç²¾è‹±ã€‘`;

      const damageToMonster = Math.max(1, player.attack - 2);
      const damageToPlayer = Math.max(1, randInt(3, 8) - player.defense);

      log(`âš”ï¸ ä½ å¯¹ ${name} é€ æˆ ${damageToMonster} ç‚¹ä¼¤å®³ï¼`, "success");

      if (isElite || isBoss) {
        log(`ğŸ”¥ ${name} æ°”æ¯ææ€–ï¼Œå°å¿ƒåº”å¯¹ï¼`, "grade-4");
      }

      if (roll(0.3)) {
        log(`ğŸŒ€ ä½ æ–½å±•ã€ŒåŸºç¡€å‰‘æœ¯ã€ï¼Œæš´å‡»ï¼`, "grade-5");
      }

      setTimeout(() => {
        log(`âœ… æˆåŠŸé•‡å‹ ${name}ï¼`, "success");
        player.killCount++;

        // æ¸¡åŠ«èƒ½é‡ +1
        player.tribEnergy += 1;
        if (player.tribEnergy >= player.maxTribEnergy && !player.inTribulation) {
          player.inTribulation = true;
          log("âš¡ èƒ½é‡å·²æ»¡ï¼å¯å°è¯•æ¸¡åŠ«çªç ´ï¼", "upgrade");
          document.getElementById("btnTrib").style.display = "block";
        }

        // æ‰è½
        if (roll(0.7)) {
          const equipment = createEquipment(player.dungeon);
          if (equipment.gradeIndex >= 5) player.stats.hasMythical = true;
          if (equipment.gradeIndex >= 6) player.stats.hasLegend = true;

          if (player.inventory.length < 50) {
            const minGrade = parseInt(document.getElementById("minGradeForPickup").value);
            const autoPick = document.getElementById("autoPickup").checked;

            if (!autoPick || equipment.gradeIndex >= minGrade) {
              player.inventory.push(equipment);
              log(`ğŸ è·å¾—æ³•å®ï¼šã€${equipment.grade}ã€‘${equipment.name}`, `grade-${equipment.gradeIndex}`);
            } else {
              log(`ğŸ—‘ï¸ è‡ªåŠ¨ä¸¢å¼ƒã€${equipment.grade}ã€‘${equipment.name}`);
            }
          } else {
            log("ğŸ’ èƒŒåŒ…å·²æ»¡ï¼Œæ— æ³•æ‹¾å–ï¼");
          }
        } else {
          const gold = randInt(1, 5) * (player.dungeon + 1);
          player.gold += gold;
          log(`ğŸ’° ç¼´è·çµçŸ³ Ã—${gold}`);
        }

        checkAchievements();
        updateUI();
      }, 600);
    }

    // ==================== åˆ›å»ºè£…å¤‡ ====================
    function createEquipment(dungeonLevel) {
      let gradeIndex = dungeonLevel + randInt(-1, 2);
      gradeIndex = Math.max(0, Math.min(6, gradeIndex));
      if (window._isBoss) gradeIndex = Math.min(6, gradeIndex + 1);

      const multiplier = GRADE_MULTIPLIERS[gradeIndex] * (1 + dungeonLevel * 0.3);
      const type = EQUIP_SLOTS[randInt(0, 4)];
      const prefix = ["æ— å", "é’é”‹", "èµ¤ç„°", "ç„å†°", "é›·éœ†", "æ˜Ÿè¾°", "æ··æ²Œ"][randInt(0, 6)];

      const equip = {
        id: Date.now() + randInt(1, 1000),
        grade: GRADES[gradeIndex],
        gradeIndex: gradeIndex,
        type: type,
        name: `${prefix}Â·${type}`,
        baseAttributes: {},
        extraAttributes: {}
      };

      const baseAttack = Math.round(5 * multiplier);
      const baseDefense = Math.round(3 * multiplier);
      if (type === "æ­¦å™¨") equip.baseAttributes["æ”»å‡»åŠ›"] = baseAttack;
      else equip.baseAttributes["é˜²å¾¡åŠ›"] = baseDefense;

      const [minE, maxE] = GRADE_EXTRA_ATTR_RANGE[gradeIndex];
      const numExtra = randInt(minE, maxE);
      const attrsPool = [...EXTRA_ATTRS];
      for (let i = 0; i < numExtra && attrsPool.length > 0; i++) {
        const idx = randInt(0, attrsPool.length - 1);
        const attr = attrsPool.splice(idx, 1)[0];
        const value = attr.f ? (Math.random() * (attr.max - attr.min) + attr.min).toFixed(1) : randInt(attr.min, attr.max);
        equip.extraAttributes[attr.n] = value;
      }

      if (gradeIndex === 6) {
        const effects = ["å¯¹BOSSä¼¤å®³+15%", "å‡»æ€å›è¡€5%", "æ‰è½ç‡+20%", "ç»éªŒ+30%"];
        equip.effect = effects[randInt(0, effects.length - 1)];
      }

      return equip;
    }

    // ==================== UI æ›´æ–° ====================
    function updateUI() {
      // è§’è‰²çŠ¶æ€
      document.getElementById("playerStats").innerHTML = `
        <strong>é“å·</strong>: æ— åé“å‹<br/>
        <strong>å¢ƒç•Œ</strong>: ã€${REALMS[player.realm]}ã€‘<br/>
        <div class="stat-row"><span>æ”»å‡»åŠ›</span><span>${player.attack}</span></div>
        <div class="stat-row"><span>é˜²å¾¡åŠ›</span><span>${player.defense}</span></div>
        <div class="stat-row"><span>çµçŸ³</span><span>${player.gold}</span></div>
        <div class="stat-row"><span>æ€æˆ®æ•°</span><span>${player.killCount}</span></div>
      `;

      // å‰¯æœ¬
      const sel = document.getElementById("dungeonSelect");
      sel.innerHTML = "";
      DUNGEONS.forEach((d, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = d.name;
        if (i === player.dungeon) opt.selected = true;
        sel.appendChild(opt);
      });
      document.getElementById("dungeonInfo").innerHTML = `éš¾åº¦ï¼š${DUNGEONS[player.dungeon].dropBase}å€ | BOSSæ¦‚ç‡ï¼š${(DUNGEONS[player.dungeon].bossChance*100).toFixed(1)}%`;

      // èƒŒåŒ…ï¼ˆé«˜å“è´¨ä¼˜å…ˆï¼‰
      const invList = document.getElementById("inventoryList");
      invList.innerHTML = "";
      [...player.inventory]
        .sort((a, b) => b.gradeIndex - a.gradeIndex)
        .slice(0, 20)
        .forEach(eq => {
          const div = document.createElement("div");
          div.className = `item grade-${eq.gradeIndex}`;
          div.innerHTML = `${eq.name}`;
          div.onclick = () => showItemDetail(eq);
          invList.appendChild(div);
        });

      // è£…å¤‡æ 
      const es = document.getElementById("equipslot");
      es.innerHTML = "";
      for (const slot of EQUIP_SLOTS) {
        const eq = player.equipment[slot];
        const item = document.createElement("div");
        item.className = "equip-slot";
        if (eq) {
          item.innerHTML = `<span class="grade-${eq.gradeIndex}">${slot}</span>ï¼š${eq.name}`;
          item.onclick = () => showItemDetail(eq);
          item.style.cursor = "pointer";
        } else {
          item.innerHTML = `<span>ç©º</span>`;
          item.style.opacity = 0.5;
        }
        es.appendChild(item);
      }

      // æˆå°±
      const achDiv = document.getElementById("achievements");
      achDiv.innerHTML = "";
      ACHIEVEMENTS.forEach(ach => {
        const item = document.createElement("div");
        item.className = `item ${player.achievements[ach.id] ? 'achieved' : ''}`;
        item.textContent = `${ach.name}ï¼š${ach.desc}`;
        achDiv.appendChild(item);
      });

      // æ¸¡åŠ«èƒ½é‡æ¡
      const progressText = document.getElementById("tribProgress");
      const energyFill = document.getElementById("energyFill");
      progressText.textContent = `${player.tribEnergy}/${player.maxTribEnergy}`;
      energyFill.style.width = `${(player.tribEnergy / player.maxTribEnergy) * 100}%`;
      document.getElementById("btnTrib").style.display = player.inTribulation ? "block" : "none";
    }

    // ==================== è£…å¤‡ç³»ç»Ÿ ====================
    function showItemDetail(item) {
      selectedItem = item;
      document.getElementById("modalTitle").textContent = item.name;
      const ul = document.getElementById("modalAttrs");
      ul.innerHTML = "";

      for (let k in item.baseAttributes) {
        const li = document.createElement("li");
        li.textContent = `${k}: +${item.baseAttributes[k]}`;
        ul.appendChild(li);
      }
      for (let k in item.extraAttributes) {
        const li = document.createElement("li");
        li.textContent = `${k}: +${item.extraAttributes[k]}`;
        ul.appendChild(li);
      }
      if (item.effect) {
        const li = document.createElement("li");
        li.style.color = "#d4af37";
        li.textContent = `âœ¨ ${item.effect}`;
        ul.appendChild(li);
      }

      const equipBtn = document.getElementById("equipBtn");
      const unequipBtn = document.getElementById("unequipBtn");
      const currentEq = player.equipment[item.type];

      if (currentEq && currentEq.id === item.id) {
        equipBtn.style.display = "none";
        unequipBtn.style.display = "inline-block";
      } else {
        equipBtn.style.display = "inline-block";
        unequipBtn.style.display = "none";
      }

      document.getElementById("itemModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("itemModal").style.display = "none";
      selectedItem = null;
    }

    function confirmEquip() {
      if (!selectedItem) return;
      const item = player.inventory.find(eq => eq.id === selectedItem.id);
      if (!item) return;

      const old = player.equipment[item.type];
      if (old) player.inventory.push(old);

      player.equipment[item.type] = item;
      player.inventory = player.inventory.filter(eq => eq.id !== item.id);
      applyEquipStats();
      log(`âš”ï¸ è£…å¤‡æ³•å®ï¼š${item.name}`, `grade-${item.gradeIndex}`);
      closeModal();
      updateUI();
    }

    function confirmUnequip() {
      if (!selectedItem) return;
      const item = player.equipment[selectedItem.type];
      if (!item) return;

      player.inventory.push(item);
      player.equipment[selectedItem.type] = null;
      applyEquipStats();
      log(`ğŸ§¼ å¸ä¸‹æ³•å®ï¼š${item.name}`);
      closeModal();
      updateUI();
    }

    function applyEquipStats() {
      let atkBonus = 0, defBonus = 0;
      for (const slot in player.equipment) {
        const eq = player.equipment[slot];
        if (!eq) continue;
        if (eq.baseAttributes["æ”»å‡»åŠ›"]) atkBonus += eq.baseAttributes["æ”»å‡»åŠ›"];
        if (eq.baseAttributes["é˜²å¾¡åŠ›"]) defBonus += eq.baseAttributes["é˜²å¾¡åŠ›"];
      }
      player.attack = 10 + atkBonus + player.realm * 5;
      player.defense = 5 + defBonus + player.realm * 2;
    }

    // ==================== åŠŸèƒ½å‡½æ•° ====================
    function discardAll() {
      const count = player.inventory.length;
      player.inventory = [];
      log(`ğŸ—‘ï¸ æ— æƒ…ä¸¢å¼ƒ ${count} ä»¶æ³•å®ï¼`);
      updateUI();
    }

    function sellAll() {
      const minSell = parseInt(prompt("å‡ºå”®ä½äºå“ªä¸ªå“è´¨ï¼Ÿ\n0=ç ´æŸ,1=æ™®é€š...", "1"));
      if (isNaN(minSell)) return;

      const filtered = player.inventory.filter(eq => eq.gradeIndex < minSell);
      const count = filtered.length;
      const gold = filtered.reduce((sum, eq) => sum + (eq.gradeIndex + 1) * 10, 0);
      player.gold += gold;
      player.inventory = player.inventory.filter(eq => eq.gradeIndex >= minSell);
      log(`ğŸ’° å‡ºå”® ${count} ä»¶æ³•å®ï¼Œè·å¾—çµçŸ³ Ã—${gold}`);
      updateUI();
    }

    function toggleMusic() {
      const btn = document.getElementById("musicBtn");
      if (bgMusic.paused) {
        bgMusic.play().then(() => btn.textContent = "ğŸ”‡ å…³é—­éŸ³ä¹").catch(() => alert("è¯·å…ˆç‚¹å‡»é¡µé¢"));
      } else {
        bgMusic.pause();
        btn.textContent = "ğŸ”Š å¼€å¯éŸ³ä¹";
      }
    }

    function attemptTribulation() {
      const successRate = 0.7 + player.realm * 0.05;
      log(`ğŸ”¥ æ¸¡åŠ«å¼€å§‹ï¼æˆåŠŸç‡çº¦ ${(successRate*100).toFixed(0)}%...`);

      setTimeout(() => {
        if (roll(successRate)) {
          player.realm++;
          player.tribEnergy = 0;
          player.inTribulation = false;
          log(`ğŸ’¥ æˆåŠŸæ¸¡åŠ«ï¼è¿›å…¥ã€${REALMS[player.realm]}ã€‘ï¼`, "upgrade");
          document.getElementById("btnTrib").style.display = "none";
          applyEquipStats();
        } else {
          player.tribEnergy = Math.max(0, player.tribEnergy - 20);
          log(`âŒ æ¸¡åŠ«å¤±è´¥ï¼èƒ½é‡å€’é€€ï¼`, "fail");
        }
        updateUI();
      }, 1500);
    }

    function checkAchievements() {
      ACHIEVEMENTS.forEach(ach => {
        if (!player.achievements[ach.id] && ach.cond(player)) {
          player.achievements[ach.id] = true;
          log(`ğŸ† è§£é”æˆå°±ï¼šã€${ach.name}ã€‘â€”â€” ${ach.desc}`, "success");
        }
      });
    }

    function saveGame() {
      try {
        localStorage.setItem("immortal_idle_save", JSON.stringify(player));
      } catch (e) {}
    }

    function loadGame() {
      try {
        const save = localStorage.getItem("immortal_idle_save");
        if (save) Object.assign(player, JSON.parse(save));
      } catch (e) {}
    }
  </script>
</body>
</html>
